name: Deploy to Environment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Docker image tag to deploy (default: latest)'
        required: false
        default: 'latest'

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        id: env
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            echo "url=https://api.yourdomain.com" >> $GITHUB_OUTPUT
            echo "bot_url=https://t.me/your_production_bot" >> $GITHUB_OUTPUT
          else
            echo "url=https://staging-api.yourdomain.com" >> $GITHUB_OUTPUT
            echo "bot_url=https://t.me/your_staging_bot" >> $GITHUB_OUTPUT
          fi

      - name: Deploy notification (start)
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'pending',
              description: 'Deploying to ${{ inputs.environment }}...',
              context: 'deploy/${{ inputs.environment }}'
            })

      - name: Deploy to server
        id: deploy
        run: |
          echo "Deployment to ${{ inputs.environment }} would happen here"
          echo "Image: ghcr.io/${{ github.repository }}/backend:${{ inputs.version }}"
          echo "url=${{ steps.env.outputs.url }}" >> $GITHUB_OUTPUT

          # Example deployment commands (customize for your infrastructure):
          # - SSH to server
          # - Pull Docker image
          # - Update docker-compose.yml
          # - Run database migrations
          # - Restart services
          # - Health check

      - name: Run database migrations
        run: |
          echo "Running migrations on ${{ inputs.environment }}"
          # ssh your-server "cd /app && docker-compose exec backend alembic upgrade head"

      - name: Health check
        run: |
          echo "Running health check on ${{ steps.env.outputs.url }}/health"
          # curl -f ${{ steps.env.outputs.url }}/health || exit 1

      - name: Deploy notification (success)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              description: 'Successfully deployed to ${{ inputs.environment }}',
              context: 'deploy/${{ inputs.environment }}',
              target_url: '${{ steps.env.outputs.url }}'
            })

      - name: Deploy notification (failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'failure',
              description: 'Deployment to ${{ inputs.environment }} failed',
              context: 'deploy/${{ inputs.environment }}'
            })

      - name: Notify Telegram (success)
        if: success() && inputs.environment == 'production'
        run: |
          # Send notification to Telegram channel
          # curl -X POST "https://api.telegram.org/bot${{ secrets.NOTIFICATION_BOT_TOKEN }}/sendMessage" \
          #   -d "chat_id=${{ secrets.NOTIFICATION_CHAT_ID }}" \
          #   -d "text=✅ Successfully deployed to production: ${{ steps.env.outputs.url }}"
          echo "Would notify Telegram about successful deployment"

      - name: Notify Telegram (failure)
        if: failure() && inputs.environment == 'production'
        run: |
          # Send notification to Telegram channel
          # curl -X POST "https://api.telegram.org/bot${{ secrets.NOTIFICATION_BOT_TOKEN }}/sendMessage" \
          #   -d "chat_id=${{ secrets.NOTIFICATION_CHAT_ID }}" \
          #   -d "text=❌ Deployment to production failed: ${{ github.sha }}"
          echo "Would notify Telegram about failed deployment"

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL:** ${{ steps.env.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Bot URL:** ${{ steps.env.outputs.bot_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ✅ Success" >> $GITHUB_STEP_SUMMARY
